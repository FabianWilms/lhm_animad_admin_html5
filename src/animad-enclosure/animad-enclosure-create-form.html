<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/iron-form/iron-form.html">
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="animad-enclosure-form.html">
<link rel="import" href="../animad-icons.html">

<dom-module id="animad-enclosure-create-form">
    <template>
        <style></style>
        <iron-ajax 
            id="httpbin" 
            url="[[url]]" 
            method="POST" 
            body="{{_data}}" 
            handle-as="json" 
            on-response="_handleResponse" 
            on-error="_handleError"
            debounce-duration="300">
        </iron-ajax>
        <!-- saved notification -->
        <paper-toast 
            id="toast_saved" 
            class="fit-bottom" 
            text="Das Formular wurde erfolgreich gespeichert.">
        </paper-toast>
        <!-- validation error notification -->
        <paper-toast 
            id="toast_error" 
            class="fit-bottom" 
            text="Das Formular konnte wegen Validierungs-Fehlern nicht gespeichert werden.">
        </paper-toast>
        <!-- request error notification -->
        <paper-toast 
            id="toast_request_error" 
            class="fit-bottom" 
            duration="0"
            text="Das Formular konnte wegen Verbindungsfehlern (Fehlercode [[_error]]) nicht gespeichert werden. Bitte wenden Sie sich an Ihren Service-Desk.">
            <paper-icon-button icon="animad-icons:close" on-tap="_closeErrorToast"></paper-icon-button>
        </paper-toast>
        <iron-form id="iform">
            <form>
                <animad-enclosure-form data="{{_data}}"></animad-enclosure-form>
                <paper-button on-tap="_sendForm" raised>Submit</paper-button>
            </form>
        </iron-form>        
    </template>
    <script>
        class AnimadEnclosureCreateForm extends Polymer.Element {
            static get is() { return 'animad-enclosure-create-form'; }

            static get properties() {
                return {
                    url: {
                        type: String
                    },
                    _data: {
                        type: Object,
                        value() {
                            return {}
                        }
                    },
                    _error: {
                        type: String
                    }
                }
            }

            constructor() {
                super();
            }

            _sendForm() {
                // check if the formcontent is valid against the defined rules
                var valid = this.$.iform.validate();

                if(valid) {
                    this.foo = JSON.stringify(this.foo);
                    console.log("form is valid: " + this.foo);
                    this.$.httpbin.generateRequest();
                } else {
                    console.log("form is not valid...");
                    this.$.toast_error.fitInto = view;
                    this.$.toast_error.open();
                }
                
            }

            _handleResponse(e) {
                console.log("response -> " + JSON.stringify(e.detail.response));
                this.$.iform.reset();
                this.foo = {};
                // open notification toast
                this.$.toast_saved.fitInto = view;
                this.$.toast_saved.open();
            }

            _handleError(event) {
                // regex for HTML status code
                var rx = /[0-9]{3}/;
                // find the code
                var findings = rx.exec(event.detail.error.message);
                // get it! (always the first value)
                this._error = findings[0];
                // open notification toast
                this.$.toast_request_error.fitInto = view;
                this.$.toast_request_error.open();
            }

            _closeErrorToast() {
                this.$.toast_request_error.close();
            }
        }

        customElements.define(AnimadEnclosureCreateForm.is, AnimadEnclosureCreateForm);
    </script>
</dom-module>